(function(){$.fn.addressJs=function(b){return new a(this,b)};function a(c,b){this.ele=c;if(!this.ele.attr("id")){this.id="addressJs"+Math.random().toString().replace("0.","");this.ele.attr("id",this.id)}this.init(b)}a.prototype={version:"0.0.2",init:function(b){this.options={};var e=this.options;e.windowWidth=$(window).width();e.windowHeight=$(window).height();e.show=false;var c=b.selected;e.lastSelected=JSON.parse(JSON.stringify(c));if(!$.isArray(c)||c.length===0){return}var d=b.field||{};e.field={keyField:d.keyField||"key",valueField:d.valueField||"value",dataField:d.dataField||"data"};e.newSelected=new Array(length);e.selectedData=new Array(length);e.isClick=true;$.extend(e,b);this.render()},getAddressData:function(b){var c=this;var d=c.options;$.ajax({url:"../data/list.json",type:"get",success:function(e){d.data=typeof e=="string"?JSON.parse(e):e;d.field={keyField:"k",valueField:"n",parent:"p"};c.formatSameLevelData();if($.isFunction(b)){b()}}})},formatSameLevelData:function(){var l=this;var i=l.options;var e=i.field;var f=e.keyField;var b=e.valueField;var x=e.parent;var o=i.selected;var h=o.length;var v=i.data;var t=v.length;var p=0;for(;p<h;p++){var w=o[p];var u=true;var g=false;var c="";var d=[];var q=0;for(;q<t;q++){var j=JSON.parse(JSON.stringify(v[q]));var s=j[x];if(p===0&&q===0){c=j}else{if(u&&w!=j[f]&&o[p-1]==s&&p>0){u=false}else{if(w==j[f]&&o[p-1]==s){g=true;c=j}}}if((!s&&p===0)||o[p-1]==s){d.push(j)}}if(!g){for(var r=p;r<h;r++){o[r]=""}}if(!u&&!g){c=d[0]}i.newSelected[p]=JSON.parse(JSON.stringify(c));i.newSelected[p].data=JSON.parse(JSON.stringify(d));o[p]=JSON.parse(JSON.stringify(i.newSelected[p][f]))}},render:function(){var b=this.options;this.createIscroll()},createIscroll:function(){var c=0;var j=this.options;var h=this.id;var d=j.selected;var e=d.length;var f=j.windowWidth/e;this.selectlinkageId=h+"-selectlinkage";var g=this.selectlinkageId+"-scroll";var b='                <article class="widget-ui-linkage-article linkage-slideInUp" id="'+this.selectlinkageId+'"><div class="widget-ui-linkage-header"><a href="javascript:void(0);" class="cancel l">取消</a><a href="javascript:void(0);" class="confirm r">确定</a></div>                <section class="widget-ui-linkage">';for(;c<e;c++){b+='<div class="widget-ui-linkage-select" style="width:'+f+'px;" id="'+g+c+'"><ul class="widget-ui-linkage-scroll" data-index="'+c+'"></ul></div>'}b+="</section></article>";$("#"+h).css("opacity","0").append(b);this.event();this.getAddressData(function(){var k=j.newSelected;j.iscroll=[];for(var m=0;m<e;m++){var l=g+m;j.iscroll.push(new IScroll("#"+l));this.createTemplate(k[m].data,m)}if(j.show){$("#"+h).removeAttr("style").show()}else{$("#"+h).removeAttr("style").hide()}this.confirm();this.createIscrollEvent()}.bind(this))},confirm:function(){var g=this.options;var b=g.confirm;var e=g.field;var f=e.keyField;if($.isFunction(b)){var d=JSON.parse(JSON.stringify(g.newSelected));for(var c=0;c<d.length;c++){g.lastSelected[c]=d[c][f]}b(d)}},createIscrollEvent:function(){var b=this;var g=b.options;var f=g.iscroll;var d=f.length;var c=0;for(;c<d;c++){var e=f[c];e.on("scrollStart",function(){g.isClick=false});e.on("scrollEnd",function(){var j=$(this.scroller);var n=Math.abs(this.y);var r=j.find("li");var p=r.height();var o=n%p;var m=Math.round(n/p);var l=r.eq(m);var q=l.attr("data-key");var h=parseInt(j.attr("data-index"));g.selected[h]=q;b.formatSameLevelData();for(var i=h+1;i<d;i++){f[i].scrollTo(0,0,0);b.createTemplate(g.newSelected[i].data,i)}this.scrollToElement($(l).get(0),0,0);g.isClick=true})}},getCreateDate:function(g){var j=this;var f=this.options;var e=f.newSelected;var b=e.length;var h=f.field;var d=h.keyField;var i=h.valueField;var k=h.dataField;var c=0;this.treeEachNode(f.selectedData[g],k,function(n,m,l){c++;if(c==1||e[g][d]==n[d]){f.selectedData[g]=n;if(g+1<b){f.selectedData[g+1]=f.selectedData[g].data||[]}}})},createTemplate:function(g,l){var j=this.options;var m=j.iscroll[l];var k=m.scroller;if(!g||$.isFunction(g)){$(k).html("<li>--</li>");return}var b=g.length;var d=j.selected;var n=j.field;var c=n.keyField;var p=n.valueField;var h="";for(var f=0;f<b;f++){var e=g[f];h+='<li data-key="'+e[c]+'">'+e[p]+"</li>"}$(k).html(h);m.refresh();var o=$(k).find('li[data-key="'+d[l]+'"]');if(o.length>0){m.scrollToElement(o.get(0),0)}},getDateData:function(){var h=this.options;var c=[[],[],[]];var e=h.intervalDate;var d=1970;var g=2099;if($.isArray(e)){d=parseInt(e[0]);g=parseInt(e[1])}var f=d;for(;f<=g;f++){c[0].push(f)}var b=1;for(;b<=12;b++){c[1].push(b)}h.data=c},event:function(){var b=this;var e=this.options;var c=e.confirm;var d=e.cancel;$("#"+b.selectlinkageId).find(".widget-ui-linkage-header a").on("click",function(){if(!e.isClick){return}if($(this).hasClass("confirm")){b.confirm()}if($(this).hasClass("cancel")&&$.isFunction(d)){d()}b.hide()})},show:function(d){$("#"+this.id).show();var f=this.options;var b=f.selected.length;var e=f.iscroll;if($.isArray(d)&&d.length==b){f.selected=d}else{f.selected=f.lastSelected}this.formatSameLevelData();
for(var c=0;c<b;c++){e[c].scrollTo(0,0,0);this.createTemplate(f.newSelected[c].data,c)}$("#"+this.selectlinkageId).addClass("linkage-slideInUp")},hide:function(){$("#"+this.selectlinkageId).addClass("linkage-slideOutDown");setTimeout(function(){$("#"+this.id).hide();$("#"+this.selectlinkageId).removeClass("linkage-slideOutDown linkage-slideInUp")}.bind(this),401)},getIScroll:function(){return this.options.iscroll},destroy:function(){var c=this.options.iscroll;if(!c){return}for(var b=0;b<c.length;b++){c[b].destroy()}delete this.options.iscroll},}})(window.Zepto||window.jQuery);